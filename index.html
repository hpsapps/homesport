<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Rotation Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        // Configuration for Tailwind CSS dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>
<body class="transition-colors duration-300">

    <div id="app-container" class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4">
        <div class="max-w-2xl mx-auto">
            <!-- Header -->
            <header class="flex justify-between items-start mb-6">
                <div class="flex-1 pr-4">
                    <h1 id="main-title" class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2 leading-tight">
                        Sport Rotation Tracker
                    </h1>
                    <p id="sub-title" class="text-gray-600 text-sm sm:text-base">
                        Teachers stay at assigned stations - Week 2
                    </p>
                </div>
                
                <button id="dark-mode-toggle" class="p-3 rounded-xl transition-all duration-300 flex-shrink-0 bg-white hover:bg-gray-50 text-gray-700 shadow-sm border border-gray-200">
                    <!-- Moon Icon -->
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class=""><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                    <!-- Sun Icon (hidden by default) -->
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                </button>
            </header>

            <!-- Week Selection Card -->
            <div id="week-card" class="bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                <div class="p-4 pb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Select Week</h2>
                </div>
                <div class="p-4 pt-0">
                    <select id="week-selector" class="w-full p-3 rounded-xl border-2 font-medium transition-all duration-200 bg-white text-gray-700 border-gray-200 focus:border-blue-300">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>

            <!-- Stage Selection Card -->
            <div id="stage-card" class="bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                <div class="p-4 pb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Select Stage</h2>
                </div>
                <div id="stage-selector" class="p-4 pt-0 grid grid-cols-2 gap-3">
                    <button data-stage="Stage 2" class="stage-btn p-4 rounded-xl border-2 font-medium transition-all duration-200 bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50 shadow-sm">Stage 2</button>
                    <button data-stage="Stage 3" class="stage-btn p-4 rounded-xl border-2 font-medium transition-all duration-200 bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50 shadow-sm">Stage 3</button>
                </div>
            </div>

            <!-- Group Selection Card (hidden initially) -->
            <div id="group-card" class="bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300 hidden">
                <div class="p-4 pb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Select Your Group</h2>
                </div>
                <div id="group-selector" class="p-4 pt-0 grid grid-cols-2 gap-3">
                    <!-- Group buttons will be populated by JS -->
                </div>
            </div>

            <!-- Teacher Info and Field Layout (hidden initially) -->
            <div id="info-container" class="hidden">
                 <!-- Teacher Info Card -->
                 <div id="teacher-info-card" class="bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                    <!-- Content will be populated by JS -->
                </div>

                <!-- Field Layout Card -->
                <div id="field-layout-card" class="bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                     <div class="p-4 pb-3">
                        <h2 class="text-lg font-semibold text-gray-900">Field Layout</h2>
                    </div>
                    <div id="field-layout-container" class="p-4 pt-0">
                        <!-- Field layout will be populated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let state = {
                selectedWeek: 2,
                selectedStage: '',
                selectedGroup: '',
                darkMode: false,
            };

            // --- EMBEDDED DATA ---
            const stage2Data = [{"Week":1,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Hoop Toss Challenge","Description":["Throw bean bags into 3 hoops at increasing distances.","Further hoop is more points."],"Equipment":"Bean bags, hoops"},{"Week":2,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Vortex Launch","Description":["Take turns launching vortexes as far as possible.","Use cones to mark distances."],"Equipment":"Vortexes, cones"},{"Week":3,"Stage":2,"Section":"Skill 1","Skill Type":["Throw","Catch"],"Activity Name":"Catch and Dash Relay","Description":["Pairs throw and catch.","After a successful catch, both sprint to tag the next pair.","Add a relay format."],"Equipment":"Footy balls, cones"},{"Week":4,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Bucket Bombs","Description":["Throw tennis balls into buckets at varying distances.","Points for each successful shot.","Further bucket is more points."],"Equipment":"Tennis balls, buckets"},{"Week":5,"Stage":2,"Section":"Skill 1","Skill Type":["Throw","Catch"],"Activity Name":"Catch Race","Description":["In pairs, race to 10 successful overarm catches.","Option B: See which pair can get the most successful catches.","Drop is restart count."],"Equipment":"Tennis balls"},{"Week":6,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Target Practice","Description":["Set up 3 goal zones.","Aim for accurate throws rather than distance.","Rotate through different objects (e.g. vortex, foxtail)."],"Equipment":"Vortexes, foxtails, cones, buckets"},{"Week":7,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Tower Knockdown","Description":["Stack cones or buckets into towers.","Take turns throwing balls to knock them down."],"Equipment":"Balls, cones or buckets"},{"Week":8,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Three-Point Shot","Description":["Throw from 3 different marked points into a goal - bucket.","Points increase with distance."],"Equipment":"Balls (cricket - tennis), buckets or goals, markers"},{"Week":9,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Tic-Tac-Throw","Description":["Relay-style game.","Throw bean bags into a 3x3 hoop grid.","Aim to create a line (like naughts and crosses)."],"Equipment":"Bean bags, hoops (in a 3x3 grid)"},{"Week":10,"Stage":2,"Section":"Skill 1","Skill Type":["Throw"],"Activity Name":"Target Bucket Relay","Description":["Player runs to a throw line and throws into a bucket.","Run back and tag next teammate.","1 point per successful shot."],"Equipment":"Buckets, bean bags or tennis balls, cones"},{"Week":1,"Stage":2,"Section":"Skill 2","Skill Type":["Dribbling","Shooting"],"Activity Name":"Zig-Zag Soccer Dribble","Description":["Dribble around cones.","Shoot into a mini goal."],"Equipment":"Soccer balls, cones, mini goals"},{"Week":2,"Stage":2,"Section":"Skill 2","Skill Type":["Dribbling","Shooting"],"Activity Name":"Shoot & Sprint Relay","Description":["Dribble to a marked line.","Shoot into goal, then sprint to end of the line."],"Equipment":"Soccer balls, cones, mini goals"},{"Week":3,"Stage":2,"Section":"Skill 2","Skill Type":["Striking"],"Activity Name":"Target Strike Cricket","Description":["Hit a stationary ball off a tee through two cones or marker posts.","Through is 3 points, successful hit but miss is 1"],"Equipment":"Cricket bats, tees, tennis balls, cones"},{"Week":4,"Stage":2,"Section":"Skill 2","Skill Type":["Striking"],"Activity Name":"Bat and Dash","Description":["Hit ball off tee, run to a cone and back before it's returned."],"Equipment":"Foam bat, soft ball, tee, cones"},{"Week":5,"Stage":2,"Section":"Skill 2","Skill Type":["Dribbling"],"Activity Name":"Obstacle Dribble Course","Description":["Dribble through a creative cone course.","Add turns and optional obstacles."],"Equipment":"Soccer or tennis balls, cones"},{"Week":6,"Stage":2,"Section":"Skill 2","Skill Type":["Dribbling","Shooting"],"Activity Name":"Hockey Cone Slalom","Description":["Dribble with a foam bat around cones.","Finish by shooting into a goal."],"Equipment":"Foam bats, balls, cones, mini goals"},{"Week":7,"Stage":2,"Section":"Skill 2","Skill Type":["Passing"],"Activity Name":"Pass and Move","Description":["In pairs: pass short distances.","After passing, sprint to a new position."],"Equipment":"Balls (soccer or tennis), cones"},{"Week":8,"Stage":2,"Section":"Skill 2","Skill Type":["Striking"],"Activity Name":"Bean Bag Baseball","Description":["Strike bean bag off a tee.","Fielders stand back outside the diamond.","Run to base before it is returned to the catcher.","Fielding team must pass the bean bag 5 times before returning it to catcher."],"Equipment":"Bean bags, bats (if striking), cones"},{"Week":9,"Stage":2,"Section":"Skill 2","Skill Type":["Rolling"],"Activity Name":"Tunnel Ball Relay","Description":["Teams line up.","Pass ball through legs to the end.","Last player runs to front. Repeat until back at starting order."],"Equipment":"Balls"},{"Week":10,"Stage":2,"Section":"Skill 2","Skill Type":["Dribbling","Shooting"],"Activity Name":"Cone Goal Knockout","Description":["Dribble and shoot to knock over cone \"goals\".","First team to knock over all wins."],"Equipment":"Soccer balls, cones"},{"Week":1,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Capture the Flag","Description":["Two teams protect their flag.","Try to steal the opponent's flag and return to base without being tagged."],"Equipment":"Cones, flags or tags"},{"Week":2,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Dodgeball","Description":["Players eliminate others by throwing soft dodgeballs.","A catch eliminates the thrower and revives a team mate.","\"Jailbreak\" to revive all players.","No headshots."],"Equipment":"Dodgeballs"},{"Week":3,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Oz-Tag Chase","Description":["Team A tries to cross a line without losing tags to Team B."],"Equipment":"Oz-tag belts"},{"Week":4,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Rob the Nest","Description":["Teams run to the centre to collect items for their nest.","Teams steal from other nests.","Most items wins."],"Equipment":"Cones, bean bags, hoops, things"},{"Week":5,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Clean Up the Yard","Description":["Teams throw soft balls over a central line.","Fewest balls on your side after 3 minutes wins.","Overthrows don't count, must be on the field."],"Equipment":"Dodgeballs"},{"Week":6,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Pin Guard","Description":["Each team guards a cone - pin while trying to knock over others'.","If your pin falls, you're out."],"Equipment":"Cones, dodgeballs"},{"Week":7,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Sinking Islands","Description":["\"Sharks\" tip \"sailors.\" Tipped players become sharks.","Sailors safe in hoops but can't stay longer than 5 sec.","Teacher removes hoop after 5 sec.","Final sailors get to \"level up\" and tag sharks."],"Equipment":"Hoops, cones (for boundaries), pinnies or belts (optional)"},{"Week":8,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Bucket Freeze","Description":["Team A: stands behind throw line, tries to throw ball into bucket","Team B: sends one runner at a time around a cone circuit","If Team A gets a ball in the bucket, the runner freezes","Next runner starts and can free any frozen runners by tagging them","Team with most players who finish a lap wins"],"Equipment":"Cones, optional balls"},{"Week":9,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Ultimate Ball","Description":["Like Ultimate Frisbee, but with a ball.","Pass to teammates without dropping.","No running with the ball."],"Equipment":"Soft ball or vortex"},{"Week":10,"Stage":2,"Section":"Game","Skill Type":["Game"],"Activity Name":"Numbers Game","Description":["Two teams are numbered.","Teacher calls out a number.","That number from each team races to get the ball and score."],"Equipment":"Ball, cones, number tags or bibs"}];
            const stage3Data = {"year6":{"Skill 1":{"activity":"Throwing/Catching","game":"Bucket Toss","description":"Throw ball in bucket, furthest bucket = more points"},"Skill 2":{"activity":"Dribble/Shooting","game":"Hockey","description":"Zig-zag dribble, shoot ball"},"Game":{"activity":"Game","game":"Capture the Flag","description":"Team-based strategy game"}},"year5":{"Skill 1":{"activity":"Throwing/Catching","game":"Bucket Toss","description":"Throw ball in bucket, furthest bucket = more points"},"Skill 2":{"activity":"Dribble/Shooting","game":"Hockey","description":"Zig-zag dribble, shoot ball"},"Game":{"activity":"Game","game":"Capture the Flag","description":"Team-based strategy game"}}};

            const teacherAssignments = {
                'Purple Reef 🏄': { stage: 'Stage 2', field: 'Year 3', station: 'Game', color: 'purple' },
                'Yellow Dune 🏜️': { stage: 'Stage 2', field: 'Year 3', station: 'Skill 2', color: 'yellow' },
                'Pink Coral 🪸': { stage: 'Stage 2', field: 'Year 3', station: 'Skill 1', color: 'pink' },
                'Red Driftwood 🪵': { stage: 'Stage 2', field: 'Year 4', station: 'Game', color: 'red' },
                'Green Waves 🌊': { stage: 'Stage 2', field: 'Year 4', station: 'Skill 2', color: 'green' },
                'Blue Lagoons 🏝️': { stage: 'Stage 2', field: 'Year 4', station: 'Skill 1', color: 'blue' },
                'Shells G 🐚': { stage: 'Stage 3', field: 'Year 6', station: 'Skill 2' },
                'Dunes H 🏜️': { stage: 'Stage 3', field: 'Year 5', station: 'Skill 1' },
                'Cliffs I ⛰️': { stage: 'Stage 3', field: 'Year 6', station: 'Skill 2' },
                'Tsunamis J ⚠️': { stage: 'Stage 3', field: 'Year 5', station: 'Skill 1' }
            };

            // --- DOM ELEMENT REFERENCES ---
            const dom = {
                html: document.documentElement,
                appContainer: document.getElementById('app-container'),
                mainTitle: document.getElementById('main-title'),
                subTitle: document.getElementById('sub-title'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                moonIcon: document.getElementById('moon-icon'),
                sunIcon: document.getElementById('sun-icon'),
                weekSelector: document.getElementById('week-selector'),
                stageCard: document.getElementById('stage-card'),
                weekCard: document.getElementById('week-card'),
                stageSelector: document.getElementById('stage-selector'),
                groupCard: document.getElementById('group-card'),
                groupSelector: document.getElementById('group-selector'),
                infoContainer: document.getElementById('info-container'),
                teacherInfoCard: document.getElementById('teacher-info-card'),
                fieldLayoutCard: document.getElementById('field-layout-card'),
                fieldLayoutContainer: document.getElementById('field-layout-container'),
            };

            // --- ICONS (for dynamic injection) ---
            const icons = {
                target: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg>`,
                mapPin: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 flex-shrink-0"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
                clock: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 text-green-600 flex-shrink-0"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
            };
            
            // --- RENDER FUNCTIONS ---
            const render = () => {
                // Update theme first
                dom.html.classList.toggle('dark', state.darkMode);
                dom.appContainer.className = state.darkMode ? 'min-h-screen bg-gray-900 p-4' : 'min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4';
                
                // Render all components that depend on state
                renderHeader();
                renderWeekSelector();
                renderStageSelector();
                renderGroupSelector();
                renderInfo();
            };

            const renderHeader = () => {
                dom.subTitle.textContent = `Teachers stay at assigned stations - Week ${state.selectedWeek}`;
                dom.mainTitle.className = state.darkMode ? 'text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-2 leading-tight' : 'text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2 leading-tight';
                dom.subTitle.className = state.darkMode ? 'text-gray-300 text-sm sm:text-base' : 'text-gray-600 text-sm sm:text-base';

                dom.moonIcon.classList.toggle('hidden', state.darkMode);
                dom.sunIcon.classList.toggle('hidden', !state.darkMode);
                dom.darkModeToggle.className = `p-3 rounded-xl transition-all duration-300 flex-shrink-0 border ${
                    state.darkMode 
                        ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400 border-gray-600'
                        : 'bg-white hover:bg-gray-50 text-gray-700 shadow-sm border-gray-200'
                }`;
            };

            const renderWeekSelector = () => {
                if(dom.weekSelector.options.length === 0) {
                    for (let i = 1; i <= 10; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Week ${i}`;
                        dom.weekSelector.appendChild(option);
                    }
                }
                dom.weekSelector.value = state.selectedWeek;
                
                dom.weekCard.className = state.darkMode ? 'bg-gray-800 border-gray-700 mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.weekCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';
                dom.weekSelector.className = `w-full p-3 rounded-xl border-2 font-medium transition-all duration-200 ${
                    state.darkMode
                        ? 'bg-gray-700 text-gray-200 border-gray-600 focus:border-blue-400'
                        : 'bg-white text-gray-700 border-gray-200 focus:border-blue-300'
                }`;
            };
            
            const renderStageSelector = () => {
                dom.stageCard.className = state.darkMode ? 'bg-gray-800 border-gray-700 mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.stageCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';

                const buttons = dom.stageSelector.querySelectorAll('.stage-btn');
                buttons.forEach(button => {
                    const stage = button.dataset.stage;
                    const isSelected = state.selectedStage === stage;
                    button.className = `stage-btn p-4 rounded-xl border-2 font-medium transition-all duration-200 ${
                        isSelected
                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white border-blue-500 shadow-lg'
                            : state.darkMode
                                ? 'bg-gray-700 text-gray-200 border-gray-600 hover:border-blue-400 hover:bg-gray-600'
                                : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50 shadow-sm'
                    }`;
                });
            };

            const renderGroupSelector = () => {
                if (!state.selectedStage) {
                    dom.groupCard.classList.add('hidden');
                    return;
                }

                dom.groupCard.classList.remove('hidden');
                dom.groupCard.className = state.darkMode ? 'bg-gray-800 border-gray-700 mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.groupCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';
                
                dom.groupSelector.innerHTML = ''; // Clear previous content

                if (state.selectedStage === 'Stage 2') {
                    // Create columns for the two Year groups
                    const col1 = document.createElement('div');
                    col1.className = 'space-y-3';
                    const col2 = document.createElement('div');
                    col2.className = 'space-y-3';

                    // Define the specific order for buttons in each column
                    const year4Order = ['Red Driftwood 🪵', 'Green Waves 🌊', 'Blue Lagoons 🏝️'];
                    const year3Order = ['Purple Reef 🏄', 'Yellow Dune 🏜️', 'Pink Coral 🪸'];

                    // Populate column 1 (Year 4)
                    year4Order.forEach(groupName => {
                        if (teacherAssignments[groupName]) {
                            const button = document.createElement('button');
                            button.textContent = groupName;
                            button.dataset.group = groupName;
                            button.className = `group-btn w-full p-4 rounded-xl border-2 text-center font-medium transition-all duration-200 ${getGroupButtonColor(groupName, state.selectedGroup === groupName)}`;
                            col1.appendChild(button);
                        }
                    });
                    
                    // Populate column 2 (Year 3)
                    year3Order.forEach(groupName => {
                        if (teacherAssignments[groupName]) {
                            const button = document.createElement('button');
                            button.textContent = groupName;
                            button.dataset.group = groupName;
                            button.className = `group-btn w-full p-4 rounded-xl border-2 text-center font-medium transition-all duration-200 ${getGroupButtonColor(groupName, state.selectedGroup === groupName)}`;
                            col2.appendChild(button);
                        }
                    });

                    dom.groupSelector.appendChild(col1);
                    dom.groupSelector.appendChild(col2);
                    
                } else { // Handle Stage 3 groups
                    const filteredGroups = Object.keys(teacherAssignments).filter(group => teacherAssignments[group].stage === state.selectedStage);
                    filteredGroups.forEach(group => {
                        const button = document.createElement('button');
                        button.textContent = group;
                        button.dataset.group = group;
                        button.className = `group-btn p-4 rounded-xl border-2 text-center font-medium transition-all duration-200 ${getGroupButtonColor(group, state.selectedGroup === group)}`;
                        dom.groupSelector.appendChild(button);
                    });
                }
            };
            
            const renderInfo = () => {
                const teacherInfo = state.selectedGroup ? getTeacherInfo(state.selectedGroup) : null;
                if (!teacherInfo || !teacherInfo.activityData) {
                    dom.infoContainer.classList.add('hidden');
                    return;
                }

                dom.infoContainer.classList.remove('hidden');

                dom.teacherInfoCard.className = state.darkMode ? 'bg-gray-800 border-gray-700 mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                const descriptionHtml = Array.isArray(teacherInfo.activityData.description) 
                    ? `<ul>${teacherInfo.activityData.description.map(d => `<li class="ml-4 list-disc">${d}</li>`).join('')}</ul>`
                    : `<p>${teacherInfo.activityData.description}</p>`;

                const accentBlue = state.darkMode ? 'bg-blue-800/40 border-blue-600/50' : 'bg-blue-50/70 border-blue-200';
                const accentGreen = state.darkMode ? 'bg-green-800/40 border-green-600/50' : 'bg-green-50/70 border-green-200';
                const accentGray = state.darkMode ? 'bg-gray-700/80 border-gray-600' : 'bg-gray-50 border-gray-200';
                const textPrimary = state.darkMode ? 'text-white' : 'text-gray-900';
                const textSecondary = state.darkMode ? 'text-gray-300' : 'text-gray-600';
                const textAccent = state.darkMode ? 'text-blue-400' : 'text-blue-600';

                dom.teacherInfoCard.innerHTML = `
                    <div class="p-4 pb-3">
                        <h3 class="flex items-center gap-2 text-lg ${textPrimary} font-semibold">
                            ${icons.target}
                            <span>You are teaching: ${teacherInfo.activityData.game}</span>
                        </h3>
                    </div>
                    <div class="p-4 pt-0 space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="flex items-center gap-3 p-3 rounded-lg border ${accentBlue}">
                                ${icons.mapPin.replace('flex-shrink-0', `flex-shrink-0 ${textAccent}`)}
                                <div class="min-w-0">
                                    <p class="font-medium text-sm ${textPrimary}">${teacherInfo.field}</p>
                                    <p class="text-xs ${textSecondary}">${teacherInfo.station}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 p-3 rounded-lg border ${accentGreen}">
                                ${icons.clock}
                                <div class="min-w-0">
                                    <p class="font-medium text-sm ${textPrimary}">~20 minutes</p>
                                    <p class="text-xs ${textSecondary}">Groups rotate to you</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-3 rounded-lg border ${accentGray} ${textSecondary} text-sm space-y-1">
                            <h4 class="font-semibold mb-1 ${textPrimary}">Description:</h4>
                            ${descriptionHtml}
                        </div>
                         <div class="p-3 rounded-lg border ${accentGray} ${textSecondary} text-sm">
                            <h4 class="font-semibold mb-1 ${textPrimary}">Equipment:</h4>
                            <p>${teacherInfo.activityData.equipment || 'N/A'}</p>
                        </div>
                    </div>
                `;
                renderFieldLayout();
            };

            const renderFieldLayout = () => {
                const teacherInfo = getTeacherInfo(state.selectedGroup);
                if (!teacherInfo) return;

                dom.fieldLayoutCard.className = state.darkMode ? 'bg-gray-800 border-gray-700 mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.fieldLayoutCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';

                const fieldsToShow = state.selectedStage === 'Stage 2' ? ['Year 4', 'Year 3'] : ['Year 6', 'Year 5'];
                const stations = ['Game', 'Skill 2', 'Skill 1'];
                
                let layoutHtml = `<div class="grid gap-3 w-full max-w-lg mx-auto ${fieldsToShow.length === 2 ? 'grid-cols-2' : 'grid-cols-4'}">`;
                fieldsToShow.forEach(field => {
                    layoutHtml += `<div class="text-center font-semibold ${state.darkMode ? 'text-gray-200' : 'text-gray-800'} text-sm p-2">${field}</div>`;
                });
                stations.forEach(station => {
                    fieldsToShow.forEach(field => {
                        const stationColorClass = getStationColor(field, station, teacherInfo.field, teacherInfo.station);
                        const activityName = getActivityForStation(field, station);
                        layoutHtml += `
                            <div class="p-3 rounded-lg text-center text-xs font-medium border transition-all ${stationColorClass}">
                                <div class="font-semibold mb-1">${station}</div>
                                <div class="opacity-80">${activityName}</div>
                            </div>`;
                    });
                });
                layoutHtml += `</div>`;
                dom.fieldLayoutContainer.innerHTML = layoutHtml;
            };

// --- HELPER FUNCTIONS ---
const getTeacherInfo = (group) => {
    const assignment = teacherAssignments[group];
    if (!assignment) return null;

    let activityData;
    if (assignment.stage === 'Stage 2') {
        const foundActivity = stage2Data.find(item => item.Week === state.selectedWeek && item.Stage === 2 && item.Section === assignment.station);
        if (foundActivity) {
            // Create a new, normalized object with lowercase keys
            activityData = {
                game: foundActivity['Activity Name'],
                description: foundActivity.Description, // Use capital 'D' from the source data
                equipment: foundActivity.Equipment      // Use capital 'E' from the source data
            };
        }
    } else { // Stage 3
        const fieldKey = assignment.field.toLowerCase().replace(' ', '');
        activityData = stage3Data[fieldKey]?.[assignment.station];
    }
    return { ...assignment, activityData };
};

            const getActivityForStation = (field, station) => {
                if (state.selectedStage === 'Stage 2') {
                    const activity = stage2Data.find(item => item.Week === state.selectedWeek && item.Stage === 2 && item.Section === station);
                    return activity ? activity['Activity Name'] : '';
                }
                if (state.selectedStage === 'Stage 3') {
                     const fieldKey = field.toLowerCase().replace(' ', '');
                     return stage3Data[fieldKey]?.[station]?.game || '';
                }
                return '';
            };
            
            const getStationColor = (field, station, highlightField, highlightStation) => {
                if (state.selectedStage === 'Stage 3') {
                    return state.darkMode ? 'bg-gray-700 text-gray-300 border-gray-600' : 'bg-gray-50 text-gray-700 border-gray-200';
                }

                const isHighlighted = highlightField === field && highlightStation === station;
                const baseColorMap = { 'Year 4': { 'Skill 1': 'blue', 'Skill 2': 'green', 'Game': 'red' }, 'Year 3': { 'Skill 1': 'pink', 'Skill 2': 'yellow', 'Game': 'purple' } };
                const baseColor = baseColorMap[field]?.[station] || 'gray';
                
                const colorSchemes = {
                    blue:   { pastel: state.darkMode ? 'bg-blue-950/20 text-gray-300 border-blue-900/30'   : 'bg-blue-50/50 text-gray-800 border-blue-100/50',   strong: state.darkMode ? 'bg-blue-600 text-white border-blue-400 shadow-lg'   : 'bg-blue-600 text-white border-blue-500 shadow-lg' },
                    green:  { pastel: state.darkMode ? 'bg-green-950/20 text-gray-300 border-green-900/30' : 'bg-green-50/50 text-gray-800 border-green-100/50', strong: state.darkMode ? 'bg-green-600 text-white border-green-400 shadow-lg' : 'bg-green-600 text-white border-green-500 shadow-lg' },
                    red:    { pastel: state.darkMode ? 'bg-red-950/20 text-gray-300 border-red-900/30'     : 'bg-red-50/50 text-gray-800 border-red-100/50',     strong: state.darkMode ? 'bg-red-600 text-white border-red-400 shadow-lg'     : 'bg-red-600 text-white border-red-500 shadow-lg' },
                    pink:   { pastel: state.darkMode ? 'bg-pink-950/20 text-gray-300 border-pink-900/30'   : 'bg-pink-50/50 text-gray-800 border-pink-100/50',   strong: state.darkMode ? 'bg-pink-600 text-white border-pink-400 shadow-lg'   : 'bg-pink-600 text-white border-pink-500 shadow-lg' },
                    yellow: { pastel: state.darkMode ? 'bg-yellow-950/20 text-gray-300 border-yellow-900/30': 'bg-yellow-50/50 text-gray-800 border-yellow-100/50',strong: state.darkMode ? 'bg-yellow-300 text-black border-yellow-400 shadow-lg': 'bg-yellow-300 text-black border-yellow-400 shadow-lg' },
                    purple: { pastel: state.darkMode ? 'bg-purple-950/20 text-gray-300 border-purple-900/30': 'bg-purple-50/50 text-gray-800 border-purple-100/50',strong: state.darkMode ? 'bg-purple-600 text-white border-purple-400 shadow-lg': 'bg-purple-600 text-white border-purple-500 shadow-lg' }
                };

                return isHighlighted ? (colorSchemes[baseColor]?.strong || colorSchemes.blue.strong) : (colorSchemes[baseColor]?.pastel || colorSchemes.blue.pastel);
            };

            const getGroupButtonColor = (group, isSelected) => {
                const color = teacherAssignments[group]?.color;
                if (!color) {
                    return isSelected
                        ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white border-blue-500 shadow-lg'
                        : state.darkMode
                            ? 'bg-gray-700 text-gray-200 border-gray-600 hover:border-blue-400 hover:bg-gray-600'
                            : 'bg-white text-gray-700 border-gray-200 hover:border-blue-300 hover:bg-blue-50 shadow-sm';
                }

                const colorSchemes = {
                     blue:   { subtle: state.darkMode ? 'bg-blue-950/20 text-gray-200 border-blue-900/30'   : 'bg-blue-50/30 text-gray-700 border-blue-100/50',   selected: state.darkMode ? 'bg-blue-700 text-white border-blue-500 shadow-lg'   : 'bg-blue-700 text-white border-blue-600 shadow-lg' , hover: state.darkMode ? 'hover:bg-blue-900/40 hover:border-blue-700/50' : 'hover:bg-blue-100/50 hover:border-blue-200/70' },
                     green:  { subtle: state.darkMode ? 'bg-green-950/20 text-gray-200 border-green-900/30' : 'bg-green-50/30 text-gray-700 border-green-100/50', selected: state.darkMode ? 'bg-green-700 text-white border-green-500 shadow-lg' : 'bg-green-700 text-white border-green-600 shadow-lg', hover: state.darkMode ? 'hover:bg-green-900/40 hover:border-green-700/50' : 'hover:bg-green-100/50 hover:border-green-200/70' },
                     red:    { subtle: state.darkMode ? 'bg-red-950/20 text-gray-200 border-red-900/30'     : 'bg-red-50/30 text-gray-700 border-red-100/50',     selected: state.darkMode ? 'bg-red-700 text-white border-red-500 shadow-lg'     : 'bg-red-700 text-white border-red-600 shadow-lg',  hover: state.darkMode ? 'hover:bg-red-900/40 hover:border-red-700/50' : 'hover:bg-red-100/50 hover:border-red-200/70' },
                     pink:   { subtle: state.darkMode ? 'bg-pink-950/20 text-gray-200 border-pink-900/30'   : 'bg-pink-50/30 text-gray-700 border-pink-100/50',   selected: state.darkMode ? 'bg-pink-700 text-white border-pink-500 shadow-lg'   : 'bg-pink-700 text-white border-pink-600 shadow-lg',  hover: state.darkMode ? 'hover:bg-pink-900/40 hover:border-pink-700/50' : 'hover:bg-pink-100/50 hover:border-pink-200/70' },
                     yellow: { subtle: state.darkMode ? 'bg-yellow-950/20 text-gray-200 border-yellow-900/30': 'bg-yellow-50/30 text-gray-700 border-yellow-100/50',selected: state.darkMode ? 'bg-yellow-300 text-black border-yellow-400 shadow-lg': 'bg-yellow-300 text-black border-yellow-400 shadow-lg',hover: state.darkMode ? 'hover:bg-yellow-900/40 hover:border-yellow-700/50' : 'hover:bg-yellow-100/50 hover:border-yellow-200/70' },
                     purple: { subtle: state.darkMode ? 'bg-purple-950/20 text-gray-200 border-purple-900/30': 'bg-purple-50/30 text-gray-700 border-purple-100/50',selected: state.darkMode ? 'bg-purple-700 text-white border-purple-500 shadow-lg': 'bg-purple-700 text-white border-purple-600 shadow-lg',hover: state.darkMode ? 'hover:bg-purple-900/40 hover:border-purple-700/50' : 'hover:bg-purple-100/50 hover:border-purple-200/70' }
                };
                const scheme = colorSchemes[color] || colorSchemes.blue;
                return isSelected ? scheme.selected : `${scheme.subtle} ${scheme.hover}`;
            };

            // --- EVENT LISTENERS ---
            dom.darkModeToggle.addEventListener('click', () => {
                state.darkMode = !state.darkMode;
                render();
            });

            dom.weekSelector.addEventListener('change', (e) => {
                state.selectedWeek = Number(e.target.value);
                state.selectedGroup = ''; 
                render();
            });

            dom.stageSelector.addEventListener('click', (e) => {
                const button = e.target.closest('.stage-btn');
                if (button) {
                    state.selectedStage = button.dataset.stage;
                    state.selectedGroup = '';
                    render();
                }
            });

            dom.groupSelector.addEventListener('click', (e) => {
                const button = e.target.closest('.group-btn');
                if (button) {
                    state.selectedGroup = button.dataset.group;
                    render();
                }
            });

            // --- INITIALIZATION ---
            render();
        });
    </script>

</body>
</html>
