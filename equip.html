<!DOCTYPE html>
<html lang="en" class="">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sport Equipment Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
    <script>
        // Configuration for Tailwind CSS dark mode
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <script>
        // Set initial dark mode to prevent FOUC
        if (localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>

<body class="transition-colors duration-300">

    <div id="app-container" class="min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <header class="flex justify-between items-start mb-6">
                <div class="flex-1 pr-4">
                    <a href="index.html">
                        <h1 id="main-title"
                            class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2 leading-tight hover:underline cursor-pointer">
                            Sport Equipment Tracker
                        </h1>
                    </a>

                </div>

                <button id="dark-mode-toggle"
                    class="p-3 rounded-xl transition-all duration-300 flex-shrink-0 bg-white hover:bg-gray-50 text-gray-700 shadow-sm border border-gray-200">
                    <!-- Moon Icon -->
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="">
                        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path>
                    </svg>
                    <!-- Sun Icon (hidden by default) -->
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="hidden">
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 2v2"></path>
                        <path d="M12 20v2"></path>
                        <path d="m4.93 4.93 1.41 1.41"></path>
                        <path d="m17.66 17.66 1.41 1.41"></path>
                        <path d="M2 12h2"></path>
                        <path d="M20 12h2"></path>
                        <path d="m6.34 17.66-1.41 1.41"></path>
                        <path d="m19.07 4.93-1.41 1.41"></path>
                    </svg>
                </button>
            </header>

            <!-- Week Selection Card -->
            <div id="week-card" class="bg-white border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                <div class="p-4 pb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Pick a week</h2>
                </div>
                <div class="p-4 pt-0">
                    <select id="week-selector" class="w-full p-3 rounded-xl border-2 font-medium transition-all duration-200 bg-white text-gray-700 border-gray-200 focus:border-blue-300">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
            </div>

            <!-- Field Layout Card -->
            <div id="field-layout-card"
                class="bg-white border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                <div class="p-4 pb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Field Layout & Equipment</h2>
                </div>
                <div id="field-layout-container" class="p-4 pt-0">
                    <!-- Field layout will be populated by JS -->
                </div>
            </div>

            <!-- Equipment Summary Card -->
            <div id="equipment-summary-card"
                class="bg-white border-gray-200 mb-4 shadow-lg border rounded-lg transition-colors duration-300">
                <div class="p-4 pb-3">
                    <h2 class="text-lg font-semibold text-gray-900">Equipment List</h2>
                </div>
                <div id="equipment-summary-container" class="p-4 pt-0">
                    <!-- Equipment summary will be populated by JS -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE MANAGEMENT ---
            let state = {
                selectedWeek: null,
                darkMode: (() => {
                    const savedMode = localStorage.getItem('darkMode');
                    if (savedMode !== null) return savedMode === 'true';
                    return window.matchMedia('(prefers-color-scheme: dark)').matches;
                })(),
                collected: {
                    stage2: { 'Game': [], 'Skill 1': [], 'Skill 2': [] },
                    stage3: { 'Game': [], 'Skill 1': [], 'Skill 2': [] }
                }
            };

            // --- DATA ---
            let allData = {
                stage2: [],
                stage3: [],
            };

            // --- DOM ELEMENT REFERENCES ---
            const dom = {
                html: document.documentElement,
                appContainer: document.getElementById('app-container'),
                mainTitle: document.getElementById('main-title'),
                weekSelector: document.getElementById('week-selector'),
                darkModeToggle: document.getElementById('dark-mode-toggle'),
                moonIcon: document.getElementById('moon-icon'),
                sunIcon: document.getElementById('sun-icon'),
                weekCard: document.getElementById('week-card'),
                fieldLayoutCard: document.getElementById('field-layout-card'),
                fieldLayoutContainer: document.getElementById('field-layout-container'),
                equipmentSummaryCard: document.getElementById('equipment-summary-card'),
                equipmentSummaryContainer: document.getElementById('equipment-summary-container'),
            };

            const getWeekByDate = () => {
                const now = new Date();
                // Define the start date of each week (Monday)
                const weekStartDates = [
                    new Date('2025-07-21'), // Week 1
                    new Date('2025-07-28'), // Week 2
                    new Date('2025-08-04'), // Week 3
                    new Date('2025-08-11'), // Week 4
                    new Date('2025-08-18'), // Week 5
                    new Date('2025-08-25'), // Week 6
                    new Date('2025-09-01'), // Week 7
                    new Date('2025-09-08'), // Week 8
                    new Date('2025-09-15'), // Week 9
                    new Date('2025-09-22'), // Week 10
                ];

                // Find the current week
                let currentWeek = 1; // Default to week 1
                for (let i = weekStartDates.length - 1; i >= 0; i--) {
                    if (now >= weekStartDates[i]) {
                        currentWeek = i + 1;
                        break;
                    }
                }

                // If the date is after the last week, default to the last week.
                if (now >= new Date('2025-09-29')) {
                    currentWeek = 10;
                }

                return currentWeek;
            };

            // --- RENDER FUNCTIONS ---
            const render = () => {
                // Update theme first
                dom.html.classList.toggle('dark', state.darkMode);
                dom.appContainer.className = state.darkMode ? 'min-h-screen bg-gray-900 p-4' : 'min-h-screen bg-gradient-to-br from-slate-50 to-blue-50 p-4';

                // Render all components
                renderHeader();
                renderWeekSelector();
                renderFieldLayout();
                renderEquipmentSummary();
            };

            const renderHeader = () => {
                dom.mainTitle.className = state.darkMode ? 'text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-2 leading-tight' : 'text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2 leading-tight';
                
                dom.moonIcon.classList.toggle('hidden', state.darkMode);
                dom.sunIcon.classList.toggle('hidden', !state.darkMode);
                dom.darkModeToggle.className = `p-3 rounded-xl transition-all duration-300 flex-shrink-0 border ${state.darkMode
                        ? 'bg-gray-700 hover:bg-gray-600 text-yellow-400 border-gray-600'
                        : 'bg-white hover:bg-gray-50 text-gray-700 shadow-sm border-gray-200'
                    }`;
            };

            const renderWeekSelector = () => {
                if(dom.weekSelector.options.length === 0) {
                    for (let i = 1; i <= 10; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `Week ${i}`;
                        dom.weekSelector.appendChild(option);
                    }
                }
                dom.weekSelector.value = state.selectedWeek;
                
                dom.weekCard.className = state.darkMode ? 'bg-gray-800 border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.weekCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';
                dom.weekSelector.className = `w-full p-3 rounded-xl border-2 font-medium transition-all duration-200 ${
                    state.darkMode
                        ? 'bg-gray-700 text-gray-200 border-gray-600 focus:border-blue-400'
                        : 'bg-white text-gray-700 border-gray-200 focus:border-blue-300'
                }`;
            };

            const renderFieldLayout = () => {
                dom.fieldLayoutCard.className = state.darkMode ? 'bg-gray-800 border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.fieldLayoutCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';

                const stations = ['Game', 'Skill 2', 'Skill 1'];
                const stages = [
                    { number: 3, years: ['Y6', 'Y5'] },
                    { number: 2, years: ['Y4', 'Y3'] }
                ];

                let layoutHtml = `<div class="grid grid-cols-2 gap-6">`;

                stages.forEach(stageInfo => {
                    layoutHtml += `
                        <div class="space-y-3">
                            <div class="text-center font-bold text-lg ${state.darkMode ? 'text-gray-100' : 'text-gray-800'} mb-4">
                                Stage ${stageInfo.number}
                            </div>
                    `;

                    stations.forEach(station => {
                        const activity = getActivityForStageStation(stageInfo.number, station);
                        const stationColorClass = getStationColor(stageInfo.number, station);
                        
                        let checkboxesHtml = '';
                        stageInfo.years.forEach(year => {
                            const isChecked = state.collected[`stage${stageInfo.number}`][station].includes(year);
                            checkboxesHtml += `
                                <label class="flex items-center space-x-2 text-xs ${state.darkMode ? 'text-gray-300' : 'text-gray-600'}">
                                    <input type="checkbox" data-stage="${stageInfo.number}" data-station="${station}" data-year="${year}" class="form-checkbox h-4 w-4 text-green-600 rounded border-gray-300 focus:ring-green-500" ${isChecked ? 'checked' : ''}>
                                    <span>${year}</span>
                                </label>
                            `;
                        });

                        layoutHtml += `
                            <div class="p-4 rounded-lg border transition-all ${stationColorClass}">
                                <div class="flex justify-between items-center mb-2 flex-wrap">
                                    <div class="font-semibold text-sm">${activity.name || 'No activity'}</div>
                                    <div class="flex space-x-2">${checkboxesHtml}</div>
                                </div>
                                <div class="text-xs font-medium">Equipment:</div>
                                <div class="text-xs opacity-80">${activity.equipment || 'None specified'}</div>
                            </div>
                        `;
                    });

                    layoutHtml += `</div>`;
                });

                layoutHtml += `</div>`;
                dom.fieldLayoutContainer.innerHTML = layoutHtml;
            };

            const renderEquipmentSummary = () => {
                dom.equipmentSummaryCard.className = state.darkMode ? 'bg-gray-800 border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300' : 'bg-white border-[#78013D] mb-4 shadow-lg border rounded-lg transition-colors duration-300';
                dom.equipmentSummaryCard.querySelector('h2').className = state.darkMode ? 'text-lg font-semibold text-white' : 'text-lg font-semibold text-gray-900';

                // Collect all equipment from both stages
                const allEquipment = new Set();

                [2, 3].forEach(stage => {
                    ['Game', 'Skill 1', 'Skill 2'].forEach(station => {
                        const activity = getActivityForStageStation(stage, station);
                        if (activity.equipment) {
                            // Split equipment by comma and clean up
                            activity.equipment.split(',').forEach(item => {
                                const cleanItem = item.trim().toLowerCase();
                                if (cleanItem && cleanItem !== 'none' && cleanItem !== 'n/a') {
                                    // Capitalize the first letter for display
                                    const displayItem = cleanItem.charAt(0).toUpperCase() + cleanItem.slice(1);
                                    allEquipment.add(displayItem);
                                }
                            });
                        }
                    });
                });

                const sortedEquipment = Array.from(allEquipment).sort();

                let summaryHtml = `
                        <ul class="space-y-1 ${state.darkMode ? 'text-gray-300' : 'text-gray-600'}">
                `;

                sortedEquipment.forEach(item => {
                    summaryHtml += `<li class="flex items-start"><span class="mr-2">•</span><span>${item}</span></li>`;
                });

                summaryHtml += `
                        </ul>
                `;

                dom.equipmentSummaryContainer.innerHTML = summaryHtml;
            };

            // --- HELPER FUNCTIONS ---
            const getActivityForStageStation = (stage, station) => {
                const dataSet = stage === 2 ? allData.stage2 : allData.stage3;
                const activity = dataSet.find(item =>
                    item.Week === state.selectedWeek &&
                    item.Stage === stage &&
                    item.Section === station
                );

                return {
                    name: activity ? activity['Activity Name'] : '',
                    equipment: activity ? activity.Equipment : ''
                };
            };

            const getStationColor = (stage, station) => {
                const colorMap = {
                    'Game': { light: 'bg-red-50/50 text-gray-800 border-red-100/50', dark: 'bg-red-950/20 text-gray-300 border-red-900/30' },
                    'Skill 2': { light: 'bg-green-50/50 text-gray-800 border-green-100/50', dark: 'bg-green-950/20 text-gray-300 border-green-900/30' },
                    'Skill 1': { light: 'bg-blue-50/50 text-gray-800 border-blue-100/50', dark: 'bg-blue-950/20 text-gray-300 border-blue-900/30' }
                };

                const colors = colorMap[station] || colorMap['Skill 1'];
                return state.darkMode ? colors.dark : colors.light;
            };

            // --- EVENT LISTENERS ---
            dom.darkModeToggle.addEventListener('click', () => {
                state.darkMode = !state.darkMode;
                localStorage.setItem('darkMode', state.darkMode);
                render();
            });

            dom.weekSelector.addEventListener('change', (e) => {
                state.selectedWeek = Number(e.target.value);
                // Reset collected state when week changes
                state.collected = { 
                    stage2: { 'Game': [], 'Skill 1': [], 'Skill 2': [] },
                    stage3: { 'Game': [], 'Skill 1': [], 'Skill 2': [] }
                };
                render();
            });

            dom.fieldLayoutContainer.addEventListener('change', (e) => {
                if (e.target.matches('input[type="checkbox"]')) {
                    const stage = e.target.dataset.stage;
                    const station = e.target.dataset.station;
                    const year = e.target.dataset.year;
                    const stageKey = `stage${stage}`;

                    if (e.target.checked) {
                        if (!state.collected[stageKey][station].includes(year)) {
                            state.collected[stageKey][station].push(year);
                        }
                    } else {
                        state.collected[stageKey][station] = state.collected[stageKey][station].filter(y => y !== year);
                    }
                    render();
                }
            });

            // --- INITIALIZATION ---
            const initialize = async () => {
                try {
                    // Set the current week based on the current date
                    state.selectedWeek = getWeekByDate();

                    const [stage2Res, stage3Res] = await Promise.all([
                        fetch('data/stage2.json'),
                        fetch('data/stage3.json')
                    ]);

                    if (!stage2Res.ok || !stage3Res.ok) {
                        throw new Error('Failed to fetch data');
                    }

                    const [stage2Data, stage3Data] = await Promise.all([
                        stage2Res.json(),
                        stage3Res.json()
                    ]);

                    allData.stage2 = stage2Data;
                    allData.stage3 = stage3Data;
                    render();
                } catch (error) {
                    console.error("Error initializing app:", error);
                    // Show error message to user
                    dom.fieldLayoutContainer.innerHTML = `
                        <div class="text-center p-8 text-red-600">
                            <p class="font-semibold">Error loading data</p>
                            <p class="text-sm">Please make sure stage2.json and stage3.json files are available</p>
                        </div>
                    `;
                }
            };

            initialize();
        });
    </script>

</body>

</html>
